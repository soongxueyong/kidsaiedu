<!-- /**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */ -->
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="tufte.ef879543.css">
   <title>KidsAIEdu TensorFLow.js编程案例</title>
  <script src="mnist.6b9b7545.js"></script>

  <style>.lang-javascript {
      width: 60%;
      padding-left: 15px;
      font-family: monospace;
    }

    script.show-script {
      display: block;
      max-width: 720px;
      background-color: floralwhite;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      margin-left: -40px;
      white-space: pre;
      margin-top: 2em;
    }

    code {
      background-color: #eee;
      padding: 2px 4px 2px 4px;
    }</style>

  <style>
  </style>
</head>

<body>
  <article>
    <h1>通过tfjs-vis编程工具训练模型</h1>
	<p>完成mnist模型训练后，用下面的小黑板手写0~9的某一个数字进行识别！</p>
	<canvas id="canvas" width="280" height="280" style="border:8px solid;"></canvas>
	<img id="canvasimg" style="width=280;height=280;display:none;">
	<input type="button" value="测试" id="sb" size="48" >
	<input type="button" value="擦除" id="cb" size="23" >

    <section>
		<h2>1.MNIST数据介绍</h2>
		<P>
			MNIST 数据集来自美国国家标准与技术研究所（National Institute of Standards and Technology ,MNIST)。
			数据训练集 (training set) 由来自 250 个不同人手写的数字构成， 其中 50% 是高中学生， 50% 来自人口
			普查局的工作人员。测试集(test set) 也是同样比例的手写数字数据。训练集为60,000个示例，而测试集为
			10,000个示例。
			每个数据是28x28像素图片，表示一个手写数字。
		</P>
		<h2>2.tfjs-vis工具介绍</h2>
      <p>
		tfjs-vis是一小组可视化交互工具程序接口，基于TensorFlow.js实现，只要会JavaScript就可以轻松创建机器学习的模型训练案例。
		本案例基于卷积神经网络，训练手写识别模型。
      </p>

      <p>
        tfjs-vis是一小组可视化交互工具程序接口:
        <ol>
          <li>创建展示数据可视化区域：遮阳板(<em>visor).</em>
          </li>
          <li>tfjs-vis基TensorFlow.js创建可视化区域，展示数据源、训练过程与模型结果。
          </li>
        </ol>
      </p>
    </section>

    <section>
      <h2>3.遮阳板(Visor) APIs</h2>
      <p>
        通过JS编程调用<code>tfvis.visor()</code>创建遮阳板(<em>visor).</em>
      </p>
      <button id="show-visor">Show Visor</button>
      <p>
        使用快捷键展示、隐藏、放大遮阳板:
        <ul>
          <li>
            <strong>`</strong> (反引号): 展示或隐藏</li>
          <li>
            <strong>~</strong> (波浪号, shift+反引号): 放大或缩小</li>
        </ul>
      </p>

      <h2>4.内容面板(Surfaces)</h2>
      <p>
        遮阳板上放内容，需要创建内容面板(Surfaces)，API如下:
        <script type="text" class="show-script">
          tfVis.visor().surface({name: 'My First Surface', tab: 'Input Data'});
        </script>
      </p>
      <button id="make-first-surface">Make a surface</button>
      <p>
        参数如下：
        <ul>
          <li>
            <strong>tfVis.visor():</strong> 遮阳板</li>
          <li>
            <strong>name:</strong> 内容面板名称 </li>
          <li>
            <strong>tab:</strong> 标签名称     </li>
        </ul>
      </p>
    </section>

    <section>
      <h2>5.案例数据装载</h2>
      <p>
        本案例使用MNIST数据集，点击装载(Load Data)和显示按钮(Show Example Digits)。</p>
      <button id="load-data">Load Data</button>
      &nbsp;&nbsp;&nbsp;
      <button id="show-examples" disabled="">Show Example Digits</button>
	  

      <p>
        
        </p><p>
          显示数据代码如下：
        </p>

        <script class="show-script">async function showExamples() {
  // 获得内容面板
  const surface = tfvis.visor().surface({
    name: 'My First Surface',
    tab: 'Input Data'
  });
  const drawArea = surface.drawArea; // Get the examples

  const examples = data.nextTestBatch(20);
  const numExamples = examples.xs.shape[0];
	// 创建canvas显示图片
  for (let i = 0; i < numExamples; i++) {
    const imageTensor = tf.tidy(() => {
      return examples.xs.slice([i, 0], [1, examples.xs.shape[1]]).reshape([28, 28, 1]);
    }); 

    const canvas = document.createElement('canvas');
    canvas.width = 28;
    canvas.height = 28;
    canvas.style = 'margin: 4px;';
    await tf.browser.toPixels(imageTensor, canvas);
    drawArea.appendChild(canvas);
    imageTensor.dispose();
  }
}

document.querySelector('#show-examples').addEventListener('click', async e => showExamples());</script>

    </section>

    <section>
      <h2>6.模型训练</h2>
      <p>
        目标是训练一个模型来识别0~9的数字。模型训练的代码如下:</p>

      <script class="show-script">async function train(model, data, fitCallbacks) {
  const BATCH_SIZE = 64;
  const trainDataSize = 500;
  const testDataSize = 100;
  const [trainXs, trainYs] = tf.tidy(() => {
    const d = data.nextTrainBatch(trainDataSize);
    return [d.xs.reshape([trainDataSize, 28, 28, 1]), d.labels];
  });
  const [testXs, testYs] = tf.tidy(() => {
    const d = data.nextTestBatch(testDataSize);
    return [d.xs.reshape([testDataSize, 28, 28, 1]), d.labels];
  });
  //前面的绘图黑板,隐藏操作按钮>
  saveButton = document.getElementById('sb');
  saveButton.hidden = false;
  clearButton.hidden = false;
  //前面的绘图黑板,隐藏操作按钮<
  //通过TensorFlow.js的APIs完成训练
  return model.fit(trainXs, trainYs, {
    batchSize: BATCH_SIZE,
    validationData: [testXs, testYs],
    epochs: 30,
    shuffle: true,
    callbacks: fitCallbacks
  });
}</script>

      <p>
        使用<code>show.fitCallbacks</code>函数，可实时展示每次批处理和每个纪元之后损益(Loss)曲线。
      </p>

      <button id="start-training-1" disabled="">Start Training</button>

      <script class="show-script">async function watchTraining() {
  const metrics = ['loss', 'val_loss', 'acc', 'val_acc'];
  const container = {
    name: 'show.fitCallbacks',
    tab: 'Training',
    styles: {
      height: '1000px'
    }
  };
  const callbacks = tfvis.show.fitCallbacks(container, metrics);
  return train(model, data, callbacks);
}

document.querySelector('#start-training-1').addEventListener('click', () => watchTraining());</script>

      <p>
        也可以等待训练完成后绘制损益(Loss)曲线。
      </p>

      <button id="start-training-2" disabled="">Start Training</button>

      <script class="show-script">async function showTrainingHistory() {
  const trainingHistory = await train(model, data);
  tfvis.show.history({
    name: 'Training History',
    tab: 'Training'
  }, trainingHistory, ['loss', 'val_loss', 'acc', 'val_acc']);
}

document.querySelector('#start-training-2').addEventListener('click', () => showTrainingHistory());</script>

     
      <p>

		也可以使用<code>render.linechart</code>函数，自定义绘制曲线，如下绘制精确度曲线。
		
      </p>

      <button id="start-training-3" disabled="">Custom Training Charts</button>

      <script class="show-script">// An array to hold training logs
const epochLogs = [];

async function customTrainingCharts() {
  const callbacks = {
    onEpochEnd: function (epoch, log) {
      const surface = {
        name: 'Custom Training Charts',
        tab: 'Training'
      };
      const options = {
        xLabel: 'Epoch',
        yLabel: 'Value',
        yAxisDomain: [0, 1],
        seriesColors: ['teal', 'tomato']
      }; // Prep the data

      epochLogs.push(log);
      const acc = epochLogs.map((log, i) => ({
        x: i,
        y: log.acc
      }));
      const valAcc = epochLogs.map((log, i) => ({
        x: i,
        y: log.val_acc
      }));
      const data = {
        values: [acc, valAcc],
        // Custom names for the series
        series: ['Accuracy', 'Validation Accuracy'] // render the chart

      };
      tfvis.render.linechart(surface, data, options);
    }
  };
  return train(model, data, callbacks);
}

document.querySelector('#start-training-3').addEventListener('click', () => customTrainingCharts());</script>

    </section>

    <section>
      <h2>7.评估模型</h2>
      <p>
        至此模型训练完成。下一步应该评估其性能。
		可以使用`perClassAccuracy`和`confusionMatrix`函数
		来查看每一个分类的模型准确度与混淆矩阵。
      </p>

      <p><button id="show-accuracy">Show per-class accuracy</button></p>
      <p><button id="show-confusion">Show confusion matrix</button></p>

      <script class="show-script">{
  const classNames = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];

  function doPrediction(testDataSize = 500) {
    const testData = data.nextTestBatch(testDataSize);
    const testxs = testData.xs.reshape([testDataSize, 28, 28, 1]);
    const labels = testData.labels.argMax([-1]);
    const preds = model.predict(testxs).argMax([-1]);
    testxs.dispose();
    return [preds, labels];
  }

  async function showAccuracy() {
    const [preds, labels] = doPrediction();
    const classAccuracy = await tfvis.metrics.perClassAccuracy(labels, preds);
    const container = {
      name: 'Accuracy',
      tab: 'Evaluation'
    };
    tfvis.show.perClassAccuracy(container, classAccuracy, classNames);
    labels.dispose();
  }

  async function showConfusion() {
    const [preds, labels] = doPrediction();
    const confusionMatrix = await tfvis.metrics.confusionMatrix(labels, preds);
    const container = {
      name: 'Confusion Matrix',
      tab: 'Evaluation'
    };
    tfvis.render.confusionMatrix(container, {
      values: confusionMatrix,
      tickLabels: classNames
    });
    labels.dispose();
  }

  document.querySelector('#show-accuracy').addEventListener('click', () => showAccuracy());
  document.querySelector('#show-confusion').addEventListener('click', () => showConfusion());

  
}</script>
  <h2>8.手写测试</h2>
  <p>
  请再回到顶部的小黑板上，自己手写0~9的一个数字，测试一下识别准确度。
  除了模型不能100%准确率识别外，中、西方数字书写的样式差别还是很大。
  参考以上编程说明，可以使用TensorFlow.js、tfjs.vis开发自己的机器学习可视化案例了。
  </p>
  

    </section>

  </article>
  <!-- 
  <canvas id="canvas" width="100" height="100" style="position:absolute;top:10;left:200;border:8px solid;"></canvas>
  <img id="canvasimg" style="position:absolute;top:10%;left:52%;width=280;height=280;display:none;">
  <input type="button" value="手绘测试" id="sb" size="48" style="position:absolute;top:50;left:330;">
  <input type="button" value="擦除手绘" id="cb" size="23" style="position:absolute;top:80;left:330;">
 -->
 <script src="exercise.js"></script>



</body>

</html>
